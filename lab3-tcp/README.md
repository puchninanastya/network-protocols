Лабораторная работа 3. 
Транспортный протокол TCP и сетевые сокеты. Механизмы протокола TCP
==============

## Установка и разрыв соединения

Выполним установку соединения между клиентом на машине c1 и сервером на машине c6.
Для просмотра пакетов запустим программу tcpdump на машине c2:

    c2:~# tcpdump -n -i eth0 tcp
    tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
    listening on eth0, link-type EN10MB (Ethernet), capture size 96 bytes
    19:27:31.556107 IP 10.10.0.2.49963 > 10.50.0.2.9: S 1554959948:1554959948(0) win 5840 <mss 1460,sackOK,timestamp 1689680 0,nop,wscale 1>
    19:27:31.594961 IP 10.50.0.2.9 > 10.10.0.2.49963: S 1545690141:1545690141(0) ack 1554959949 win 5792 <mss 536,sackOK,timestamp 1689666 1689680,nop,wscale 1>
    19:27:31.595381 IP 10.10.0.2.49963 > 10.50.0.2.9: . ack 1 win 2920 <nop,nop,timestamp 1689690 1689666>
    19:27:47.422150 IP 10.10.0.2.49963 > 10.50.0.2.9: P 1:19(18) ack 1 win 2920 <nop,nop,timestamp 1691273 1689666>
    19:27:47.422668 IP 10.50.0.2.9 > 10.10.0.2.49963: . ack 19 win 2896 <nop,nop,timestamp 1691249 1691273>
    19:28:28.781102 IP 10.10.0.2.49963 > 10.50.0.2.9: F 19:19(0) ack 1 win 2920 <nop,nop,timestamp 1695409 1691249>
    19:28:28.782662 IP 10.50.0.2.9 > 10.10.0.2.49963: F 1:1(0) ack 20 win 2896 <nop,nop,timestamp 1695385 1695409>
    19:28:28.782795 IP 10.10.0.2.49963 > 10.50.0.2.9: . ack 2 win 2920 <nop,nop,timestamp 1695409 1695385>

Для просмотра пакетов запустим программу tcpdump на машине c3:

    c3:~# tcpdump -n -i eth0 tcp
    tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
    listening on eth0, link-type EN10MB (Ethernet), capture size 96 bytes
    19:27:31.233001 IP 10.10.0.2.49963 > 10.50.0.2.9: S 1554959948:1554959948(0) win 5840 <mss 1460,sackOK,timestamp 1689680 0,nop,wscale 1>
    19:27:31.255763 IP 10.50.0.2.9 > 10.10.0.2.49963: S 1545690141:1545690141(0) ack 1554959949 win 5792 <mss 536,sackOK,timestamp 1689666 1689680,nop,wscale 1>
    19:27:31.256962 IP 10.10.0.2.49963 > 10.50.0.2.9: . ack 1 win 2920 <nop,nop,timestamp 1689690 1689666>
    19:27:47.083125 IP 10.10.0.2.49963 > 10.50.0.2.9: P 1:19(18) ack 1 win 2920 <nop,nop,timestamp 1691273 1689666>
    19:27:47.083482 IP 10.50.0.2.9 > 10.10.0.2.49963: . ack 19 win 2896 <nop,nop,timestamp 1691249 1691273>
    19:28:28.442155 IP 10.10.0.2.49963 > 10.50.0.2.9: F 19:19(0) ack 1 win 2920 <nop,nop,timestamp 1695409 1691249>
    19:28:28.443499 IP 10.50.0.2.9 > 10.10.0.2.49963: F 1:1(0) ack 20 win 2896 <nop,nop,timestamp 1695385 1695409>
    19:28:28.443767 IP 10.10.0.2.49963 > 10.50.0.2.9: . ack 2 win 2920 <nop,nop,timestamp 1695409 1695385>

Можем наблюдать, что происходит установка соединения, передача данных и разрыв соединения между машинами с1 и c6. При установке соединения между клиентом и сервером, машины c2 и c3 устанавливают значения MSS в пакетах с установленным SYN флагом. Как видно из вывода программы tcpdump, устанавливаются значения mss 1460 и 536, что меньше на 40 байт MTU соответствующих подсетей. Данное значение устанавливается благодаря конфигурации MSS Clamping из файла /etc/firewall. 

##Окно получателя

Выполним tcpdump на машине c3:

    c3:~# tcpdump -n -i eth0 tcp
    tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
    listening on eth0, link-type EN10MB (Ethernet), capture size 96 bytes
    23:18:25.512115 IP 10.10.0.2.56505 > 10.30.0.2.3002: S 4068114091:4068114091(0) win 5840 <mss 1460,sackOK,timestamp 3075109 0,nop,wscale 1>
    23:18:25.524089 IP 10.30.0.2.3002 > 10.10.0.2.56505: S 4069257248:4069257248(0) ack 4068114092 win 2096 <mss 536,sackOK,timestamp 3075087 3075109,nop,wscale 1>
    23:18:25.525146 IP 10.10.0.2.56505 > 10.30.0.2.3002: . ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.525822 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 1:525(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.525981 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 525 win 1572 <nop,nop,timestamp 3075087 3075117>
    23:18:25.526127 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 525:1049(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.526257 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 1049 win 2096 <nop,nop,timestamp 3075087 3075117>
    23:18:25.526625 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 1049:1573(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.526781 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 1573 win 2620 <nop,nop,timestamp 3075087 3075117>
    23:18:25.526929 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 1573:2097(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.527076 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 2097 win 3144 <nop,nop,timestamp 3075087 3075117>
    23:18:25.527220 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 2097:2621(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.527347 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 2621 win 3668 <nop,nop,timestamp 3075087 3075117>
    23:18:25.527488 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 2621:3145(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.527617 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 3145 win 4192 <nop,nop,timestamp 3075087 3075117>
    23:18:25.527940 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 3145:3669(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.528095 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 3669 win 4716 <nop,nop,timestamp 3075087 3075117>
    23:18:25.528244 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 3669:4193(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.528365 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 4193 win 5240 <nop,nop,timestamp 3075087 3075117>
    23:18:25.528645 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 4193:4717(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.528758 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 4717 win 5764 <nop,nop,timestamp 3075087 3075117>
    23:18:25.529036 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 4717:5241(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.529149 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 5241 win 6288 <nop,nop,timestamp 3075087 3075117>
    23:18:25.529422 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 5241:5765(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.529533 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 5765 win 6812 <nop,nop,timestamp 3075087 3075117>
    23:18:25.529810 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 5765:6289(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.529923 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 6289 win 7336 <nop,nop,timestamp 3075087 3075117>
    23:18:25.530258 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 6289:6813(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.530312 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 6813 win 7860 <nop,nop,timestamp 3075087 3075117>
    23:18:25.530630 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 6813:7337(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.530682 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 7337 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.531252 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 7337:7861(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.531307 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 7861 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.531645 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 7861:8193(332) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.531699 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 8193 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.532084 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 8193:8717(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.532468 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 8717:9241(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.532533 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 9241 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.532890 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 9241:9765(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.533099 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 9765:10289(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.533153 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 10289 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.533474 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 10289:10813(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.533679 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 10813:11337(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.533734 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 11337 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.534053 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 11337:11861(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.534257 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 11861:12385(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.534309 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 12385 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.534627 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 12385:12909(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.534976 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 12909:13433(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.535034 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 13433 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.535326 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 13433:13957(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.535562 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 13957:14481(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.535641 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 14481 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.536013 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 14481:15005(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.536218 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 15005:15529(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.536270 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 15529 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.536522 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 15529:16053(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.536691 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 16053:16385(332) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.536741 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 16385 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.537176 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 16385:16909(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.537377 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 16909:17433(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.537430 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 17433 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.537665 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 17433:17957(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.537842 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 17957:18481(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.537895 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 18481 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.539472 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 18481:19005(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.539637 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 19005:19529(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.539781 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 19529:20053(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.539972 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 20053:20577(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.540115 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 20577:21101(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.540253 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 21101:21625(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.540391 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 21625:22149(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.540526 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 22149:22673(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.540666 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 22673:23197(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.540800 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 23197:23721(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.540937 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 23721:24245(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.541131 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 24245:24577(332) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.541614 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 24577:25101(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.541778 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 25101:25625(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.541924 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 25625:26149(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.542062 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 26149:26673(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.542202 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 26673:27197(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.542288 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 27197 win 4026 <nop,nop,timestamp 3075087 3075117>
    23:18:25.542448 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 27197:27721(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.542496 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 27721 win 3764 <nop,nop,timestamp 3075087 3075117>
    23:18:25.542792 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 27721:28245(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.542846 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 28245 win 3502 <nop,nop,timestamp 3075087 3075117>
    23:18:25.543025 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 28245:28769(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.543075 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 28769 win 3240 <nop,nop,timestamp 3075087 3075117>
    23:18:25.543236 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 28769:29293(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.543284 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 29293 win 3144 <nop,nop,timestamp 3075087 3075117>
    23:18:25.543445 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 29293:29817(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.543492 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 29817 win 3668 <nop,nop,timestamp 3075087 3075117>
    23:18:25.543647 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 29817:30341(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.543694 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 30341 win 4192 <nop,nop,timestamp 3075087 3075117>
    23:18:25.543849 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 30341:30865(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.544007 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 30865 win 4716 <nop,nop,timestamp 3075087 3075117>
    23:18:25.544232 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 30865:31389(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.544287 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 31389 win 5240 <nop,nop,timestamp 3075087 3075117>
    23:18:25.544448 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 31389:31913(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.544498 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 31913 win 5764 <nop,nop,timestamp 3075087 3075117>
    23:18:25.544747 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 31913:32437(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.544798 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 32437 win 6288 <nop,nop,timestamp 3075087 3075117>
    23:18:25.545184 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 32437:32769(332) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.545250 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 32769 win 6812 <nop,nop,timestamp 3075087 3075117>
    23:18:25.546000 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 32769:33293(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.546345 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 33293:33817(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.546545 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 33817:34341(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.546624 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 34341:34865(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.546730 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 34865:35389(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.546888 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 35389:35913(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.546941 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 35913:36437(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547010 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 36437:36961(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547050 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 36961:37485(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547095 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 37485:38009(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547122 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 38009:38533(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547148 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 38533:39057(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547173 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 39057:39581(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547198 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 39581:40105(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547222 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 40105:40629(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547248 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 40629:40961(332) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547278 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 33293 win 7336 <nop,nop,timestamp 3075087 3075117>
    23:18:25.547336 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 33817 win 7860 <nop,nop,timestamp 3075087 3075117>
    23:18:25.547518 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 34341 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.547575 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 40961:41485(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547669 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 41485:42009(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547696 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 42009:42533(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547721 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 42533:43057(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547788 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 43057:43581(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547831 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 43581:44105(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547858 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 44105:44629(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.547935 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 35389 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.547997 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 36437 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.548173 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 37485 win 8384 <nop,nop,timestamp 3075087 3075117>
    23:18:25.548315 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 44629:45153(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.548472 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 45153:45677(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.548592 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 45677:46201(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.548619 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 46201:46725(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.548665 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 46725:47249(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.548706 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 47249:47773(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.548777 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 47773:48297(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.548849 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 48297:48821(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.548942 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 48821:49345(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.548983 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 49345:49869(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.549009 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 49869:50393(524) ack 1 win 2920 <nop,nop,timestamp 3075117 3075087>
    23:18:25.558426 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 50393 win 6288 <nop,nop,timestamp 3075091 3075117>
    23:18:25.558944 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 50393:50917(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559017 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 50917:51441(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559055 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 51441:51965(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559301 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 51965:52489(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559340 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 52489:53013(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559369 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 53013:53537(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559399 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 53537:54061(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559430 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 54061:54585(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559466 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 54585:55109(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559503 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 55109:55633(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559531 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 55633:56157(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559557 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 56157:56681(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559582 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 56681:57205(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559607 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 57205:57345(140) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559652 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 50917 win 6812 <nop,nop,timestamp 3075091 3075121>
    23:18:25.559690 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 57345:57869(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559717 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 57869:58393(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559743 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 58393:58917(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559818 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 58917:59441(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559844 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 59441:59965(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559911 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 59965:60489(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559939 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 60489:61013(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559964 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 61013:61537(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.559989 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 61537:62061(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.560014 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 62061:62585(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.560038 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 62585:63109(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.560063 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 63109:63633(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.560087 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 63633:64157(524) ack 1 win 2920 <nop,nop,timestamp 3075121 3075091>
    23:18:25.607308 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 64157 win 740 <nop,nop,timestamp 3075096 3075121>
    23:18:25.607601 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 64157:64681(524) ack 1 win 2920 <nop,nop,timestamp 3075126 3075096>
    23:18:25.607661 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 64681:65205(524) ack 1 win 2920 <nop,nop,timestamp 3075126 3075096>
    23:18:25.647456 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 65205 win 216 <nop,nop,timestamp 3075100 3075126>
    23:18:25.867064 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 65205:65637(432) ack 1 win 2920 <nop,nop,timestamp 3075152 3075100>
    23:18:25.867273 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 65637 win 1048 <nop,nop,timestamp 3075121 3075152>
    23:18:25.867752 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 65637:65729(92) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.867808 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 65729:66253(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.867975 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 66253:66777(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.868062 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 66777:67301(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.868149 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 66253 win 1572 <nop,nop,timestamp 3075121 3075152>
    23:18:25.868225 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 66777 win 2096 <nop,nop,timestamp 3075121 3075152>
    23:18:25.868284 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 67301 win 2620 <nop,nop,timestamp 3075121 3075152>
    23:18:25.868706 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 67301:67825(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.868762 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 67825:68349(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.868811 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 68349:68873(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.868860 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 68873:69397(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.868907 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 69397:69921(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.868955 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 69921:70445(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.869002 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 70445:70969(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.869064 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 70969:71493(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.869176 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 71493:72017(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.869237 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 72017:72541(524) ack 1 win 2920 <nop,nop,timestamp 3075152 3075121>
    23:18:25.897497 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 72541 win 1808 <nop,nop,timestamp 3075125 3075152>
    23:18:25.897990 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 72541:73065(524) ack 1 win 2920 <nop,nop,timestamp 3075155 3075125>
    23:18:25.898085 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 73065:73589(524) ack 1 win 2920 <nop,nop,timestamp 3075155 3075125>
    23:18:25.898105 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 73589:74113(524) ack 1 win 2920 <nop,nop,timestamp 3075155 3075125>
    23:18:25.898117 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 74113:74637(524) ack 1 win 2920 <nop,nop,timestamp 3075155 3075125>
    23:18:25.898123 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 74637:75161(524) ack 1 win 2920 <nop,nop,timestamp 3075155 3075125>
    23:18:25.898128 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 75161:75685(524) ack 1 win 2920 <nop,nop,timestamp 3075155 3075125>
    23:18:25.947409 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 75685 win 1280 <nop,nop,timestamp 3075130 3075155>
    23:18:25.948034 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 75685:76209(524) ack 1 win 2920 <nop,nop,timestamp 3075160 3075130>
    23:18:25.948072 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 76209:76733(524) ack 1 win 2920 <nop,nop,timestamp 3075160 3075130>
    23:18:25.948078 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 76733:77257(524) ack 1 win 2920 <nop,nop,timestamp 3075160 3075130>
    23:18:25.948085 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 77257:77781(524) ack 1 win 2920 <nop,nop,timestamp 3075160 3075130>
    23:18:25.987320 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 77781 win 962 <nop,nop,timestamp 3075134 3075160>
    23:18:25.987759 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 77781:78305(524) ack 1 win 2920 <nop,nop,timestamp 3075164 3075134>
    23:18:25.987780 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 78305:78829(524) ack 1 win 2920 <nop,nop,timestamp 3075164 3075134>
    23:18:25.987787 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 78829:79353(524) ack 1 win 2920 <nop,nop,timestamp 3075164 3075134>
    23:18:26.027496 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 79353 win 176 <nop,nop,timestamp 3075138 3075164>
    23:18:26.257769 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 79353:79705(352) ack 1 win 2920 <nop,nop,timestamp 3075191 3075138>
    23:18:26.258037 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 79705 win 0 <nop,nop,timestamp 3075161 3075191>
    23:18:26.477771 IP 10.10.0.2.56505 > 10.30.0.2.3002: . ack 1 win 2920 <nop,nop,timestamp 3075213 3075161>
    23:18:26.478122 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 79705 win 0 <nop,nop,timestamp 3075183 3075191>
    23:18:26.917048 IP 10.10.0.2.56505 > 10.30.0.2.3002: . ack 1 win 2920 <nop,nop,timestamp 3075257 3075183>
    23:18:26.917280 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 79705 win 0 <nop,nop,timestamp 3075226 3075191>
    23:18:27.528184 IP 10.30.0.2.3002 > 10.10.0.2.56505: . ack 79705 win 524 <nop,nop,timestamp 3075288 3075191>
    23:18:27.528243 IP 10.30.0.2.3002 > 10.10.0.2.56505: R 1:1(0) ack 79705 win 524 <nop,nop,timestamp 3075288 3075191>
    23:18:27.530371 IP 10.10.0.2.56505 > 10.30.0.2.3002: P 79705:79877(172) ack 1 win 2920 <nop,nop,timestamp 3075318 3075288>
    23:18:27.530465 IP 10.10.0.2.56505 > 10.30.0.2.3002: . 79877:80401(524) ack 1 win 2920 <nop,nop,timestamp 3075318 3075288>
    23:18:27.530598 IP 10.30.0.2.3002 > 10.10.0.2.56505: R 4069257249:4069257249(0) win 0
    23:18:27.530730 IP 10.30.0.2.3002 > 10.10.0.2.56505: R 4069257249:4069257249(0) win 0

В последних пакетах можем наблюдать передачу размера окна получателя от машины c4 равного 0.


При запуске netcat и win на одной машине (c4), tcpdump показывает использование большего начально размера окна получателя:

    c4:~# ./win 3002 2 10 &
    [1] 702
    c4:~# tcpdump -n -i lo tcp
    tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
    listening on lo, link-type EN10MB (Ethernet), capture size 96 bytes
    23:53:09.896450 IP 127.0.0.1.47152 > 127.0.0.1.3002: S 948916796:948916796(0) win 32792 <mss 16396,sackOK,timestamp 3393716 0,nop,wscale 1>
    23:53:09.896468 IP 127.0.0.1.3002 > 127.0.0.1.47152: S 941813452:941813452(0) ack 948916797 win 32768 <mss 16396,sackOK,timestamp 3393716 3393716,nop,wscale 1>
    23:53:09.896477 IP 127.0.0.1.47152 > 127.0.0.1.3002: . ack 1 win 16396 <nop,nop,timestamp 3393716 3393716>
    23:53:09.898602 IP 127.0.0.1.47152 > 127.0.0.1.3002: P 1:8193(8192) ack 1 win 16396 <nop,nop,timestamp 3393716 3393716>
    23:53:09.898609 IP 127.0.0.1.3002 > 127.0.0.1.47152: . ack 8193 win 24576 <nop,nop,timestamp 3393716 3393716>
    23:53:09.898794 IP 127.0.0.1.47152 > 127.0.0.1.3002: P 8193:16385(8192) ack 1 win 16396 <nop,nop,timestamp 3393716 3393716>
    23:53:09.898797 IP 127.0.0.1.3002 > 127.0.0.1.47152: . ack 16385 win 24576 <nop,nop,timestamp 3393716 3393716>
    23:53:09.898955 IP 127.0.0.1.47152 > 127.0.0.1.3002: P 16385:24577(8192) ack 1 win 16396 <nop,nop,timestamp 3393716 3393716>
    23:53:09.898960 IP 127.0.0.1.3002 > 127.0.0.1.47152: . ack 24577 win 23120 <nop,nop,timestamp 3393716 3393716>
    23:53:09.899172 IP 127.0.0.1.47152 > 127.0.0.1.3002: P 24577:32769(8192) ack 1 win 16396 <nop,nop,timestamp 3393716 3393716>
    23:53:09.899350 IP 127.0.0.1.47152 > 127.0.0.1.3002: P 32769:49153(16384) ack 1 win 16396 <nop,nop,timestamp 3393716 3393716>
    23:53:09.899707 IP 127.0.0.1.47152 > 127.0.0.1.3002: P 49153:65537(16384) ack 1 win 16396 <nop,nop,timestamp 3393716 3393716>
    23:53:09.930149 IP 127.0.0.1.3002 > 127.0.0.1.47152: . ack 65537 win 2640 <nop,nop,timestamp 3393720 3393716>
    23:53:10.140226 IP 127.0.0.1.47152 > 127.0.0.1.3002: P 65537:70817(5280) ack 1 win 16396 <nop,nop,timestamp 3393741 3393720>
    23:53:10.140240 IP 127.0.0.1.3002 > 127.0.0.1.47152: . ack 70817 win 0 <nop,nop,timestamp 3393741 3393741>
    23:53:10.350290 IP 127.0.0.1.47152 > 127.0.0.1.3002: . ack 1 win 16396 <nop,nop,timestamp 3393762 3393741>
    23:53:10.350310 IP 127.0.0.1.3002 > 127.0.0.1.47152: . ack 70817 win 0 <nop,nop,timestamp 3393762 3393741>
    23:53:10.770243 IP 127.0.0.1.47152 > 127.0.0.1.3002: . ack 1 win 16396 <nop,nop,timestamp 3393804 3393762>
    23:53:10.770252 IP 127.0.0.1.3002 > 127.0.0.1.47152: . ack 70817 win 0 <nop,nop,timestamp 3393804 3393741>
    23:53:11.611170 IP 127.0.0.1.47152 > 127.0.0.1.3002: . ack 1 win 16396 <nop,nop,timestamp 3393889 3393804>
    23:53:11.611180 IP 127.0.0.1.3002 > 127.0.0.1.47152: . ack 70817 win 0 <nop,nop,timestamp 3393889 3393741>
    23:53:11.900535 IP 127.0.0.1.3002 > 127.0.0.1.47152: . ack 70817 win 8420 <nop,nop,timestamp 3393917 3393741>
    23:53:11.900545 IP 127.0.0.1.47152 > 127.0.0.1.3002: P 70817:81921(11104) ack 1 win 16396 <nop,nop,timestamp 3393917 3393917>
    23:53:11.900550 IP 127.0.0.1.3002 > 127.0.0.1.47152: . ack 81921 win 2868 <nop,nop,timestamp 3393917 3393917>
    23:53:11.900771 IP 127.0.0.1.3002 > 127.0.0.1.47152: R 1:1(0) ack 81921 win 24576 <nop,nop,timestamp 3393917 3393917>

##Окно отправителя

Установим значение задержки канала на машине c5 - 100мс. Запустим tcpdump на машине c2 и выполним запуск программы nagle в режиме nodelay: 

    c2:~# tcpdump -n -i eth0 tcp
    tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
    listening on eth0, link-type EN10MB (Ethernet), capture size 96 bytes
    00:40:35.234295 IP 10.10.0.2.58786 > 10.40.0.2.9: S 2625845709:2625845709(0) win 5840 <mss 1460,sackOK,timestamp 3678266 0,nop,wscale 1>
    00:40:35.464302 IP 10.40.0.2.9 > 10.10.0.2.58786: S 2617252657:2617252657(0) ack 2625845710 win 5792 <mss 1460,sackOK,timestamp 3678262 3678266,nop,wscale 1>
    00:40:35.465016 IP 10.10.0.2.58786 > 10.40.0.2.9: . ack 1 win 2920 <nop,nop,timestamp 3678291 3678262>
    00:40:35.465041 IP 10.10.0.2.58786 > 10.40.0.2.9: P 1:101(100) ack 1 win 2920 <nop,nop,timestamp 3678291 3678262>
    00:40:35.474843 IP 10.10.0.2.58786 > 10.40.0.2.9: P 101:201(100) ack 1 win 2920 <nop,nop,timestamp 3678293 3678262>
    00:40:35.574337 IP 10.40.0.2.9 > 10.10.0.2.58786: . ack 101 win 2896 <nop,nop,timestamp 3678273 3678291>
    00:40:35.574741 IP 10.10.0.2.58786 > 10.40.0.2.9: P 201:1201(1000) ack 1 win 2920 <nop,nop,timestamp 3678302 3678273>
    00:40:35.585106 IP 10.10.0.2.58786 > 10.40.0.2.9: P 1201:1301(100) ack 1 win 2920 <nop,nop,timestamp 3678304 3678273>
    00:40:35.585130 IP 10.40.0.2.9 > 10.10.0.2.58786: . ack 201 win 2896 <nop,nop,timestamp 3678273 3678293>
    00:40:35.590588 IP 10.10.0.2.58786 > 10.40.0.2.9: P 1301:1401(100) ack 1 win 2920 <nop,nop,timestamp 3678304 3678273>
    00:40:35.600574 IP 10.10.0.2.58786 > 10.40.0.2.9: P 1401:1501(100) ack 1 win 2920 <nop,nop,timestamp 3678305 3678273>
    00:40:35.660872 IP 10.10.0.2.58786 > 10.40.0.2.9: FP 1501:2001(500) ack 1 win 2920 <nop,nop,timestamp 3678311 3678273>
    00:40:35.684009 IP 10.40.0.2.9 > 10.10.0.2.58786: . ack 1201 win 3896 <nop,nop,timestamp 3678284 3678302>
    00:40:35.693866 IP 10.40.0.2.9 > 10.10.0.2.58786: . ack 1301 win 3896 <nop,nop,timestamp 3678286 3678304>
    00:40:35.693921 IP 10.40.0.2.9 > 10.10.0.2.58786: . ack 1401 win 3896 <nop,nop,timestamp 3678286 3678304>
    00:40:35.704097 IP 10.40.0.2.9 > 10.10.0.2.58786: . ack 1501 win 3896 <nop,nop,timestamp 3678287 3678305>
    00:40:35.764101 IP 10.40.0.2.9 > 10.10.0.2.58786: F 1:1(0) ack 2002 win 4896 <nop,nop,timestamp 3678292 3678311>
    00:40:35.764223 IP 10.10.0.2.58786 > 10.40.0.2.9: . ack 2 win 2920 <nop,nop,timestamp 3678321 3678292>
    00:40:54.770127 IP 10.10.0.2.58787 > 10.40.0.2.9: S 2920532563:2920532563(0) win 5840 <mss 1460,sackOK,timestamp 3680222 0,nop,wscale 1>
    00:40:54.874111 IP 10.40.0.2.9 > 10.10.0.2.58787: S 2919064180:2919064180(0) ack 2920532564 win 5792 <mss 1460,sackOK,timestamp 3680203 3680222,nop,wscale 1>
    00:40:54.874307 IP 10.10.0.2.58787 > 10.40.0.2.9: . ack 1 win 2920 <nop,nop,timestamp 3680232 3680203>
    00:40:54.874613 IP 10.10.0.2.58787 > 10.40.0.2.9: P 1:101(100) ack 1 win 2920 <nop,nop,timestamp 3680232 3680203>
    00:40:54.882253 IP 10.10.0.2.58787 > 10.40.0.2.9: P 101:201(100) ack 1 win 2920 <nop,nop,timestamp 3680234 3680203>
    00:40:54.890707 IP 10.10.0.2.58787 > 10.40.0.2.9: P 201:301(100) ack 1 win 2920 <nop,nop,timestamp 3680234 3680203>
    00:40:54.984220 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 101 win 2896 <nop,nop,timestamp 3680214 3680232>
    00:40:54.984238 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 201 win 2896 <nop,nop,timestamp 3680214 3680234>
    00:40:54.984656 IP 10.10.0.2.58787 > 10.40.0.2.9: P 301:1201(900) ack 1 win 2920 <nop,nop,timestamp 3680243 3680214>
    00:40:54.995334 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 301 win 2896 <nop,nop,timestamp 3680216 3680234>
    00:40:54.995985 IP 10.10.0.2.58787 > 10.40.0.2.9: P 1201:1301(100) ack 1 win 2920 <nop,nop,timestamp 3680245 3680216>
    00:40:55.001652 IP 10.10.0.2.58787 > 10.40.0.2.9: P 1301:1401(100) ack 1 win 2920 <nop,nop,timestamp 3680246 3680216>
    00:40:55.010867 IP 10.10.0.2.58787 > 10.40.0.2.9: P 1401:1501(100) ack 1 win 2920 <nop,nop,timestamp 3680246 3680216>
    00:40:55.020791 IP 10.10.0.2.58787 > 10.40.0.2.9: P 1501:1601(100) ack 1 win 2920 <nop,nop,timestamp 3680247 3680216>
    00:40:55.030797 IP 10.10.0.2.58787 > 10.40.0.2.9: P 1601:1701(100) ack 1 win 2920 <nop,nop,timestamp 3680248 3680216>
    00:40:55.093941 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 1201 win 3796 <nop,nop,timestamp 3680225 3680243>
    00:40:55.094304 IP 10.10.0.2.58787 > 10.40.0.2.9: P 1701:2301(600) ack 1 win 2920 <nop,nop,timestamp 3680254 3680225>
    00:40:55.104472 IP 10.10.0.2.58787 > 10.40.0.2.9: P 2301:2401(100) ack 1 win 2920 <nop,nop,timestamp 3680256 3680225>
    00:40:55.104577 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 1301 win 3796 <nop,nop,timestamp 3680227 3680245>
    00:40:55.104616 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 1401 win 3796 <nop,nop,timestamp 3680227 3680246>
    00:40:55.110838 IP 10.10.0.2.58787 > 10.40.0.2.9: P 2401:2501(100) ack 1 win 2920 <nop,nop,timestamp 3680256 3680227>
    00:40:55.118501 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 1501 win 3796 <nop,nop,timestamp 3680228 3680246>
    00:40:55.122568 IP 10.10.0.2.58787 > 10.40.0.2.9: P 2501:2601(100) ack 1 win 2920 <nop,nop,timestamp 3680258 3680228>
    00:40:55.124174 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 1601 win 3796 <nop,nop,timestamp 3680229 3680247>
    00:40:55.134157 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 1701 win 3796 <nop,nop,timestamp 3680230 3680248>
    00:40:55.134543 IP 10.10.0.2.58787 > 10.40.0.2.9: P 2601:2701(100) ack 1 win 2920 <nop,nop,timestamp 3680259 3680230>
    00:40:55.140859 IP 10.10.0.2.58787 > 10.40.0.2.9: P 2701:2801(100) ack 1 win 2920 <nop,nop,timestamp 3680259 3680230>
    00:40:55.150941 IP 10.10.0.2.58787 > 10.40.0.2.9: P 2801:2901(100) ack 1 win 2920 <nop,nop,timestamp 3680260 3680230>
    00:40:55.160857 IP 10.10.0.2.58787 > 10.40.0.2.9: P 2901:3001(100) ack 1 win 2920 <nop,nop,timestamp 3680261 3680230>
    00:40:55.170820 IP 10.10.0.2.58787 > 10.40.0.2.9: P 3001:3101(100) ack 1 win 2920 <nop,nop,timestamp 3680262 3680230>
    00:40:55.204049 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 2301 win 4696 <nop,nop,timestamp 3680236 3680254>
    00:40:55.204576 IP 10.10.0.2.58787 > 10.40.0.2.9: P 3101:3201(100) ack 1 win 2920 <nop,nop,timestamp 3680265 3680236>
    00:40:55.214954 IP 10.10.0.2.58787 > 10.40.0.2.9: P 3201:3301(100) ack 1 win 2920 <nop,nop,timestamp 3680267 3680236>
    00:40:55.215132 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 2401 win 4696 <nop,nop,timestamp 3680237 3680256>
    00:40:55.215169 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 2501 win 4696 <nop,nop,timestamp 3680237 3680256>
    00:40:55.220424 IP 10.10.0.2.58787 > 10.40.0.2.9: P 3301:3401(100) ack 1 win 2920 <nop,nop,timestamp 3680267 3680237>
    00:40:55.228017 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 2601 win 4696 <nop,nop,timestamp 3680239 3680258>
    00:40:55.236492 IP 10.10.0.2.58787 > 10.40.0.2.9: P 3401:3501(100) ack 1 win 2920 <nop,nop,timestamp 3680269 3680239>
    00:40:55.240838 IP 10.10.0.2.58787 > 10.40.0.2.9: P 3501:3601(100) ack 1 win 2920 <nop,nop,timestamp 3680269 3680239>
    00:40:55.250456 IP 10.10.0.2.58787 > 10.40.0.2.9: P 3601:3701(100) ack 1 win 2920 <nop,nop,timestamp 3680270 3680239>
    00:40:55.260658 IP 10.10.0.2.58787 > 10.40.0.2.9: P 3701:3801(100) ack 1 win 2920 <nop,nop,timestamp 3680271 3680239>
    00:40:55.260684 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 2701 win 4696 <nop,nop,timestamp 3680240 3680259>
    00:40:55.260690 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 2801 win 4696 <nop,nop,timestamp 3680240 3680259>
    00:40:55.260693 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 2901 win 4696 <nop,nop,timestamp 3680242 3680260>
    00:40:55.264759 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 3001 win 4696 <nop,nop,timestamp 3680243 3680261>
    00:40:55.274182 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 3101 win 4696 <nop,nop,timestamp 3680244 3680262>
    00:40:55.283273 IP 10.10.0.2.58787 > 10.40.0.2.9: P 3801:3901(100) ack 1 win 2920 <nop,nop,timestamp 3680274 3680244>
    00:40:55.292954 IP 10.10.0.2.58787 > 10.40.0.2.9: P 3901:4001(100) ack 1 win 2920 <nop,nop,timestamp 3680275 3680244>
    00:40:55.300782 IP 10.10.0.2.58787 > 10.40.0.2.9: P 4001:4101(100) ack 1 win 2920 <nop,nop,timestamp 3680275 3680244>
    00:40:55.307874 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 3201 win 4696 <nop,nop,timestamp 3680247 3680265>
    00:40:55.317171 IP 10.10.0.2.58787 > 10.40.0.2.9: P 4101:4201(100) ack 1 win 2920 <nop,nop,timestamp 3680277 3680247>
    00:40:55.320673 IP 10.10.0.2.58787 > 10.40.0.2.9: P 4201:4301(100) ack 1 win 2920 <nop,nop,timestamp 3680277 3680247>
    00:40:55.330683 IP 10.10.0.2.58787 > 10.40.0.2.9: P 4301:4401(100) ack 1 win 2920 <nop,nop,timestamp 3680278 3680247>
    00:40:55.330701 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 3301 win 4696 <nop,nop,timestamp 3680249 3680267>
    00:40:55.330714 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 3401 win 4696 <nop,nop,timestamp 3680249 3680267>
    00:40:55.341067 IP 10.10.0.2.58787 > 10.40.0.2.9: P 4401:4501(100) ack 1 win 2920 <nop,nop,timestamp 3680280 3680249>
    00:40:55.349297 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 3501 win 4696 <nop,nop,timestamp 3680250 3680269>
    00:40:55.349309 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 3601 win 4696 <nop,nop,timestamp 3680250 3680269>
    00:40:55.353928 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 3701 win 4696 <nop,nop,timestamp 3680250 3680270>
    00:40:55.361736 IP 10.10.0.2.58787 > 10.40.0.2.9: P 4501:4601(100) ack 1 win 2920 <nop,nop,timestamp 3680282 3680250>
    00:40:55.370887 IP 10.10.0.2.58787 > 10.40.0.2.9: P 4601:4701(100) ack 1 win 2920 <nop,nop,timestamp 3680283 3680250>
    00:40:55.379205 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 3801 win 4696 <nop,nop,timestamp 3680253 3680271>
    00:40:55.383979 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 3901 win 4696 <nop,nop,timestamp 3680254 3680274>
    00:40:55.391720 IP 10.10.0.2.58787 > 10.40.0.2.9: P 4701:4801(100) ack 1 win 2920 <nop,nop,timestamp 3680285 3680254>
    00:40:55.400497 IP 10.10.0.2.58787 > 10.40.0.2.9: P 4801:4901(100) ack 1 win 2920 <nop,nop,timestamp 3680285 3680254>
    00:40:55.409011 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 4001 win 4696 <nop,nop,timestamp 3680255 3680275>
    00:40:55.409073 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 4101 win 4696 <nop,nop,timestamp 3680257 3680275>
    00:40:55.419471 IP 10.10.0.2.58787 > 10.40.0.2.9: P 4901:5001(100) ack 1 win 2920 <nop,nop,timestamp 3680287 3680257>
    00:40:55.421262 IP 10.10.0.2.58787 > 10.40.0.2.9: F 5001:5001(0) ack 1 win 2920 <nop,nop,timestamp 3680287 3680257>
    00:40:55.432247 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 4201 win 4696 <nop,nop,timestamp 3680258 3680277>
    00:40:55.432311 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 4301 win 4696 <nop,nop,timestamp 3680258 3680277>
    00:40:55.432335 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 4401 win 4696 <nop,nop,timestamp 3680260 3680278>
    00:40:55.444087 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 4501 win 4696 <nop,nop,timestamp 3680260 3680280>
    00:40:55.463898 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 4601 win 4696 <nop,nop,timestamp 3680262 3680282>
    00:40:55.473962 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 4701 win 4696 <nop,nop,timestamp 3680262 3680283>
    00:40:55.494055 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 4801 win 4696 <nop,nop,timestamp 3680265 3680285>
    00:40:55.504150 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 4901 win 4696 <nop,nop,timestamp 3680265 3680285>
    00:40:55.524102 IP 10.40.0.2.9 > 10.10.0.2.58787: . ack 5001 win 4696 <nop,nop,timestamp 3680268 3680287>
    00:40:55.524112 IP 10.40.0.2.9 > 10.10.0.2.58787: F 1:1(0) ack 5002 win 4696 <nop,nop,timestamp 3680268 3680287>
    00:40:55.524323 IP 10.10.0.2.58787 > 10.40.0.2.9: . ack 2 win 2920 <nop,nop,timestamp 3680298 3680268>


##Нейгл и Мишналь

Выполним проверку работы алгоритма Нейгла при отправке сообщений с машины c1 на машину c5 при включенной задержке на c5 - 100мс. Выполним команду на машине c1:

    ./nagle default 10.40.0.2 9 0 30

и прослушаем интерфейс eth0 на машине c2:

    c2:~# tcpdump -n -i eth0 tcp
    tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
    listening on eth0, link-type EN10MB (Ethernet), capture size 96 bytes
    02:08:08.199297 IP 10.10.0.2.36578 > 10.40.0.2.9: S 3369312717:3369312717(0) win 5840 <mss 1460,sackOK,timestamp 4203563 0,nop,wscale 1>
    02:08:08.424362 IP 10.40.0.2.9 > 10.10.0.2.36578: S 3383125525:3383125525(0) ack 3369312718 win 5792 <mss 1460,sackOK,timestamp 4203558 4203563,nop,wscale 1>
    02:08:08.425101 IP 10.10.0.2.36578 > 10.40.0.2.9: . ack 1 win 2920 <nop,nop,timestamp 4203588 4203558>
    02:08:08.425126 IP 10.10.0.2.36578 > 10.40.0.2.9: P 1:101(100) ack 1 win 2920 <nop,nop,timestamp 4203588 4203558>
    02:08:08.490731 IP 10.10.0.2.36578 > 10.40.0.2.9: . 101:1549(1448) ack 1 win 2920 <nop,nop,timestamp 4203594 4203558>
    02:08:08.534381 IP 10.40.0.2.9 > 10.10.0.2.36578: . ack 101 win 2896 <nop,nop,timestamp 4203569 4203588>
    02:08:08.534859 IP 10.10.0.2.36578 > 10.40.0.2.9: P 1549:2401(852) ack 1 win 2920 <nop,nop,timestamp 4203599 4203569>
    02:08:08.582746 IP 10.10.0.2.36578 > 10.40.0.2.9: FP 2401:3001(600) ack 1 win 2920 <nop,nop,timestamp 4203604 4203569>
    02:08:08.594806 IP 10.40.0.2.9 > 10.10.0.2.36578: . ack 1549 win 4344 <nop,nop,timestamp 4203575 4203594>
    02:08:08.645142 IP 10.40.0.2.9 > 10.10.0.2.36578: . ack 2401 win 5792 <nop,nop,timestamp 4203580 4203599>
    02:08:08.694570 IP 10.40.0.2.9 > 10.10.0.2.36578: F 1:1(0) ack 3002 win 7240 <nop,nop,timestamp 4203584 4203604>
    02:08:08.694854 IP 10.10.0.2.36578 > 10.40.0.2.9: . ack 2 win 2920 <nop,nop,timestamp 4203614 4203584>

Видим, что посылается неполный сегмент, как только подтвержден все неполные сегменты (даже если полные не подтверждены) - подтвержден неполный сегмент 1:101 (ack 101) и не подтвержден сегмент 101:1549, но следующий сегмент отправлен. Алгоритм Нейгла работает.

##Аггрессивная буферизация

Выполним команду tcpdump:

    02:20:33.099403 IP 10.10.0.2.52293 > 10.40.0.2.9: S 2183596683:2183596683(0) win 5840 <mss 1460,sackOK,timestamp 4278054 0,nop,wscale 1>
    02:20:33.204154 IP 10.40.0.2.9 > 10.10.0.2.52293: S 2182779443:2182779443(0) ack 2183596684 win 5792 <mss 1460,sackOK,timestamp 4278036 4278054,nop,wscale 1>
    02:20:33.204350 IP 10.10.0.2.52293 > 10.40.0.2.9: . ack 1 win 2920 <nop,nop,timestamp 4278065 4278036>
    02:20:33.670603 IP 10.10.0.2.52293 > 10.40.0.2.9: P 1:201(200) ack 1 win 2920 <nop,nop,timestamp 4278112 4278036>
    02:20:33.774193 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 201 win 3432 <nop,nop,timestamp 4278093 4278112>
    02:20:34.480594 IP 10.10.0.2.52293 > 10.40.0.2.9: P 201:401(200) ack 1 win 2920 <nop,nop,timestamp 4278193 4278093>
    02:20:34.584373 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 401 win 3968 <nop,nop,timestamp 4278174 4278193>
    02:20:35.260695 IP 10.10.0.2.52293 > 10.40.0.2.9: P 401:601(200) ack 1 win 2920 <nop,nop,timestamp 4278271 4278174>
    02:20:35.363961 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 601 win 4504 <nop,nop,timestamp 4278252 4278271>
    02:20:36.041056 IP 10.10.0.2.52293 > 10.40.0.2.9: P 601:701(100) ack 1 win 2920 <nop,nop,timestamp 4278350 4278252>
    02:20:36.144171 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 701 win 4504 <nop,nop,timestamp 4278330 4278350>
    02:20:36.531556 IP 10.10.0.2.52293 > 10.40.0.2.9: P 701:901(200) ack 1 win 2920 <nop,nop,timestamp 4278399 4278330>
    02:20:36.634058 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 901 win 4504 <nop,nop,timestamp 4278379 4278399>
    02:20:37.230932 IP 10.10.0.2.52293 > 10.40.0.2.9: P 901:1001(100) ack 1 win 2920 <nop,nop,timestamp 4278469 4278379>
    02:20:37.334089 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 1001 win 4504 <nop,nop,timestamp 4278449 4278469>
    02:20:37.680576 IP 10.10.0.2.52293 > 10.40.0.2.9: P 1001:1101(100) ack 1 win 2920 <nop,nop,timestamp 4278513 4278449>
    02:20:37.784436 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 1101 win 4504 <nop,nop,timestamp 4278494 4278513>
    02:20:38.111346 IP 10.10.0.2.52293 > 10.40.0.2.9: P 1101:1301(200) ack 1 win 2920 <nop,nop,timestamp 4278557 4278494>
    02:20:38.214430 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 1301 win 4504 <nop,nop,timestamp 4278537 4278557>
    02:20:38.831035 IP 10.10.0.2.52293 > 10.40.0.2.9: P 1301:1401(100) ack 1 win 2920 <nop,nop,timestamp 4278629 4278537>
    02:20:38.934251 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 1401 win 4504 <nop,nop,timestamp 4278609 4278629>
    02:20:39.260528 IP 10.10.0.2.52293 > 10.40.0.2.9: P 1401:1501(100) ack 1 win 2920 <nop,nop,timestamp 4278671 4278609>
    02:20:39.364225 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 1501 win 4504 <nop,nop,timestamp 4278652 4278671>
    02:20:39.681065 IP 10.10.0.2.52293 > 10.40.0.2.9: P 1501:1601(100) ack 1 win 2920 <nop,nop,timestamp 4278714 4278652>
    02:20:39.784616 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 1601 win 4504 <nop,nop,timestamp 4278694 4278714>
    02:20:40.120762 IP 10.10.0.2.52293 > 10.40.0.2.9: P 1601:1701(100) ack 1 win 2920 <nop,nop,timestamp 4278757 4278694>
    02:20:40.224211 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 1701 win 4504 <nop,nop,timestamp 4278738 4278757>
    02:20:40.540956 IP 10.10.0.2.52293 > 10.40.0.2.9: P 1701:1901(200) ack 1 win 2920 <nop,nop,timestamp 4278800 4278738>
    02:20:40.644308 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 1901 win 4504 <nop,nop,timestamp 4278780 4278800>
    02:20:41.260636 IP 10.10.0.2.52293 > 10.40.0.2.9: P 1901:2001(100) ack 1 win 2920 <nop,nop,timestamp 4278871 4278780>
    02:20:41.364461 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 2001 win 4504 <nop,nop,timestamp 4278852 4278871>
    02:20:41.700597 IP 10.10.0.2.52293 > 10.40.0.2.9: P 2001:2101(100) ack 1 win 2920 <nop,nop,timestamp 4278915 4278852>
    02:20:41.803993 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 2101 win 4504 <nop,nop,timestamp 4278896 4278915>
    02:20:42.130811 IP 10.10.0.2.52293 > 10.40.0.2.9: P 2101:2201(100) ack 1 win 2920 <nop,nop,timestamp 4278958 4278896>
    02:20:42.234480 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 2201 win 4504 <nop,nop,timestamp 4278939 4278958>
    02:20:42.551166 IP 10.10.0.2.52293 > 10.40.0.2.9: P 2201:2301(100) ack 1 win 2920 <nop,nop,timestamp 4279001 4278939>
    02:20:42.654324 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 2301 win 4504 <nop,nop,timestamp 4278981 4279001>
    02:20:42.981502 IP 10.10.0.2.52293 > 10.40.0.2.9: P 2301:2501(200) ack 1 win 2920 <nop,nop,timestamp 4279044 4278981>
    02:20:43.084126 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 2501 win 4504 <nop,nop,timestamp 4279024 4279044>
    02:20:43.710869 IP 10.10.0.2.52293 > 10.40.0.2.9: P 2501:2601(100) ack 1 win 2920 <nop,nop,timestamp 4279117 4279024>
    02:20:43.814478 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 2601 win 4504 <nop,nop,timestamp 4279097 4279117>
    02:20:44.131109 IP 10.10.0.2.52293 > 10.40.0.2.9: P 2601:2701(100) ack 1 win 2920 <nop,nop,timestamp 4279159 4279097>
    02:20:44.233961 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 2701 win 4504 <nop,nop,timestamp 4279139 4279159>
    02:20:44.560443 IP 10.10.0.2.52293 > 10.40.0.2.9: P 2701:2801(100) ack 1 win 2920 <nop,nop,timestamp 4279201 4279139>
    02:20:44.664153 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 2801 win 4504 <nop,nop,timestamp 4279182 4279201>
    02:20:44.980910 IP 10.10.0.2.52293 > 10.40.0.2.9: P 2801:2901(100) ack 1 win 2920 <nop,nop,timestamp 4279244 4279182>
    02:20:45.084291 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 2901 win 4504 <nop,nop,timestamp 4279224 4279244>
    02:20:45.410799 IP 10.10.0.2.52293 > 10.40.0.2.9: P 2901:3001(100) ack 1 win 2920 <nop,nop,timestamp 4279287 4279224>
    02:20:45.410889 IP 10.10.0.2.52293 > 10.40.0.2.9: F 3001:3001(0) ack 1 win 2920 <nop,nop,timestamp 4279287 4279224>
    02:20:45.513966 IP 10.40.0.2.9 > 10.10.0.2.52293: . ack 3001 win 4504 <nop,nop,timestamp 4279267 4279287>
    02:20:45.513983 IP 10.40.0.2.9 > 10.10.0.2.52293: F 1:1(0) ack 3002 win 4504 <nop,nop,timestamp 4279267 4279287>
    02:20:45.514216 IP 10.10.0.2.52293 > 10.40.0.2.9: . ack 2 win 2920 <nop,nop,timestamp 4279296 4279267>

##Отправка без задержки

Выполним команду tcpdump на машине c2:

    c2:~# tcpdump -n -i eth0 tcp
    tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
    listening on eth0, link-type EN10MB (Ethernet), capture size 96 bytes
    02:27:09.093689 IP 10.10.0.2.46982 > 10.40.0.2.9: S 4085532118:4085532118(0) win 5840 <mss 1460,sackOK,timestamp 4317654 0,nop,wscale 1>
    02:27:09.194471 IP 10.40.0.2.9 > 10.10.0.2.46982: S 4084532559:4084532559(0) ack 4085532119 win 5792 <mss 1460,sackOK,timestamp 4317635 4317654,nop,wscale 1>
    02:27:09.194781 IP 10.10.0.2.46982 > 10.40.0.2.9: . ack 1 win 2920 <nop,nop,timestamp 4317664 4317635>
    02:27:09.194811 IP 10.10.0.2.46982 > 10.40.0.2.9: P 1:101(100) ack 1 win 2920 <nop,nop,timestamp 4317664 4317635>
    02:27:09.205201 IP 10.10.0.2.46982 > 10.40.0.2.9: P 101:201(100) ack 1 win 2920 <nop,nop,timestamp 4317666 4317635>
    02:27:09.205268 IP 10.10.0.2.46982 > 10.40.0.2.9: P 201:301(100) ack 1 win 2920 <nop,nop,timestamp 4317666 4317635>
    02:27:09.304036 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 101 win 2896 <nop,nop,timestamp 4317646 4317664>
    02:27:09.304426 IP 10.10.0.2.46982 > 10.40.0.2.9: P 301:1301(1000) ack 1 win 2920 <nop,nop,timestamp 4317675 4317646>
    02:27:09.315145 IP 10.10.0.2.46982 > 10.40.0.2.9: P 1301:1401(100) ack 1 win 2920 <nop,nop,timestamp 4317677 4317646>
    02:27:09.315315 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 201 win 2896 <nop,nop,timestamp 4317646 4317666>
    02:27:09.315321 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 301 win 2896 <nop,nop,timestamp 4317646 4317666>
    02:27:09.315389 IP 10.10.0.2.46982 > 10.40.0.2.9: P 1401:1601(200) ack 1 win 2920 <nop,nop,timestamp 4317677 4317646>
    02:27:09.320626 IP 10.10.0.2.46982 > 10.40.0.2.9: P 1601:1701(100) ack 1 win 2920 <nop,nop,timestamp 4317677 4317646>
    02:27:09.330639 IP 10.10.0.2.46982 > 10.40.0.2.9: P 1701:1801(100) ack 1 win 2920 <nop,nop,timestamp 4317678 4317646>
    02:27:09.340641 IP 10.10.0.2.46982 > 10.40.0.2.9: P 1801:1901(100) ack 1 win 2920 <nop,nop,timestamp 4317679 4317646>
    02:27:09.414196 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 1301 win 3896 <nop,nop,timestamp 4317657 4317675>
    02:27:09.414587 IP 10.10.0.2.46982 > 10.40.0.2.9: P 1901:2801(900) ack 1 win 2920 <nop,nop,timestamp 4317686 4317657>
    02:27:09.425144 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 1401 win 3896 <nop,nop,timestamp 4317659 4317677>
    02:27:09.425159 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 1601 win 4896 <nop,nop,timestamp 4317659 4317677>
    02:27:09.425164 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 1701 win 4896 <nop,nop,timestamp 4317659 4317677>
    02:27:09.425621 IP 10.10.0.2.46982 > 10.40.0.2.9: P 2801:2901(100) ack 1 win 2920 <nop,nop,timestamp 4317688 4317659>
    02:27:09.430753 IP 10.10.0.2.46982 > 10.40.0.2.9: P 2901:3001(100) ack 1 win 2920 <nop,nop,timestamp 4317688 4317659>
    02:27:09.438291 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 1801 win 4896 <nop,nop,timestamp 4317660 4317678>
    02:27:09.444219 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 1901 win 4896 <nop,nop,timestamp 4317661 4317679>
    02:27:09.452378 IP 10.10.0.2.46982 > 10.40.0.2.9: F 3001:3001(0) ack 1 win 2920 <nop,nop,timestamp 4317691 4317661>
    02:27:09.524184 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 2801 win 5896 <nop,nop,timestamp 4317668 4317686>
    02:27:09.535063 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 2901 win 5896 <nop,nop,timestamp 4317670 4317688>
    02:27:09.535083 IP 10.40.0.2.9 > 10.10.0.2.46982: . ack 3001 win 5896 <nop,nop,timestamp 4317670 4317688>
    02:27:09.553891 IP 10.40.0.2.9 > 10.10.0.2.46982: F 1:1(0) ack 3002 win 5896 <nop,nop,timestamp 4317671 4317691>
    02:27:09.554040 IP 10.10.0.2.46982 > 10.40.0.2.9: . ack 2 win 2920 <nop,nop,timestamp 4317700 4317671>

Видим, что nodelay не помогает, когда окно отправителя полное


##Быстрый повтор

    02:55:00.157528 IP 10.10.0.2.53371 > 10.30.0.2.9: S 238230828:238230828(0) win 5840 <mss 1460,sackOK,timestamp 4484788 0,nop,wscale 1
    >
    02:55:03.142829 IP 10.10.0.2.53371 > 10.30.0.2.9: S 238230828:238230828(0) win 5840 <mss 1460,sackOK,timestamp 4485088 0,nop,wscale 1
    >
    02:55:03.143616 IP 10.30.0.2.9 > 10.10.0.2.53371: S 291026442:291026442(0) ack 238230829 win 2096 <mss 536,sackOK,timestamp 4485053 4
    485088,nop,wscale 1>
    02:55:03.143633 IP 10.10.0.2.53371 > 10.30.0.2.9: . ack 1 win 2920 <nop,nop,timestamp 4485088 4485053>
    02:55:03.144084 IP 10.10.0.2.53371 > 10.30.0.2.9: P 1:101(100) ack 1 win 2920 <nop,nop,timestamp 4485088 4485053>
    02:55:03.147213 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 101 win 1048 <nop,nop,timestamp 4485053 4485088>
    02:55:03.156877 IP 10.10.0.2.53371 > 10.30.0.2.9: P 101:201(100) ack 1 win 2920 <nop,nop,timestamp 4485089 4485053>
    02:55:03.157834 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 201 win 1048 <nop,nop,timestamp 4485055 4485089>
    02:55:03.163557 IP 10.10.0.2.53371 > 10.30.0.2.9: P 201:301(100) ack 1 win 2920 <nop,nop,timestamp 4485090 4485055>
    02:55:03.164179 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 301 win 1048 <nop,nop,timestamp 4485055 4485090>
    02:55:03.173827 IP 10.10.0.2.53371 > 10.30.0.2.9: P 301:401(100) ack 1 win 2920 <nop,nop,timestamp 4485091 4485055>
    02:55:03.174123 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 401 win 1048 <nop,nop,timestamp 4485057 4485091>
    02:55:03.182724 IP 10.10.0.2.53371 > 10.30.0.2.9: P 401:501(100) ack 1 win 2920 <nop,nop,timestamp 4485092 4485057>
    02:55:03.193002 IP 10.10.0.2.53371 > 10.30.0.2.9: P 501:601(100) ack 1 win 2920 <nop,nop,timestamp 4485093 4485057>
    02:55:03.193732 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 601 win 1048 <nop,nop,timestamp 4485058 4485093>
    02:55:03.203916 IP 10.10.0.2.53371 > 10.30.0.2.9: P 601:701(100) ack 1 win 2920 <nop,nop,timestamp 4485094 4485058>
    02:55:03.204669 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 701 win 1048 <nop,nop,timestamp 4485060 4485094>
    02:55:03.213821 IP 10.10.0.2.53371 > 10.30.0.2.9: P 701:801(100) ack 1 win 2920 <nop,nop,timestamp 4485095 4485060>
    02:55:03.214267 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 801 win 1048 <nop,nop,timestamp 4485061 4485095>
    02:55:03.223481 IP 10.10.0.2.53371 > 10.30.0.2.9: P 801:901(100) ack 1 win 2920 <nop,nop,timestamp 4485096 4485061>
    02:55:03.223988 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 901 win 1048 <nop,nop,timestamp 4485062 4485096>
    02:55:03.233634 IP 10.10.0.2.53371 > 10.30.0.2.9: P 901:1001(100) ack 1 win 2920 <nop,nop,timestamp 4485097 4485062>
    02:55:03.234191 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 1001 win 1048 <nop,nop,timestamp 4485062 4485097>
    02:55:03.243506 IP 10.10.0.2.53371 > 10.30.0.2.9: P 1001:1101(100) ack 1 win 2920 <nop,nop,timestamp 4485098 4485062>
    02:55:03.244285 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 1101 win 1048 <nop,nop,timestamp 4485064 4485098>
    02:55:03.253761 IP 10.10.0.2.53371 > 10.30.0.2.9: P 1101:1201(100) ack 1 win 2920 <nop,nop,timestamp 4485099 4485064>
    02:55:03.263146 IP 10.10.0.2.53371 > 10.30.0.2.9: P 1201:1301(100) ack 1 win 2920 <nop,nop,timestamp 4485100 4485064>
    02:55:03.263780 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 1101 win 1048 <nop,nop,timestamp 4485065 4485098,nop,nop,sack 1 {1201:1301}>
    02:55:03.273265 IP 10.10.0.2.53371 > 10.30.0.2.9: P 1301:1401(100) ack 1 win 2920 <nop,nop,timestamp 4485101 4485065>
    02:55:03.273860 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 1101 win 1048 <nop,nop,timestamp 4485066 4485098,nop,nop,sack 1 {1201:1401}>
    02:55:03.283568 IP 10.10.0.2.53371 > 10.30.0.2.9: P 1401:1501(100) ack 1 win 2920 <nop,nop,timestamp 4485102 4485066>
    02:55:03.284253 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 1101 win 1048 <nop,nop,timestamp 4485068 4485098,nop,nop,sack 1 {1201:1501}>
    02:55:03.284276 IP 10.10.0.2.53371 > 10.30.0.2.9: P 1101:1201(100) ack 1 win 2920 <nop,nop,timestamp 4485102 4485068>
    02:55:03.284802 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 1501 win 1048 <nop,nop,timestamp 4485068 4485102>
    02:55:03.294496 IP 10.10.0.2.53371 > 10.30.0.2.9: P 1501:1601(100) ack 1 win 2920 <nop,nop,timestamp 4485103 4485068>
    02:55:03.295097 IP 10.30.0.2.9 > 10.10.0.2.53371: . ack 1601 win 1048 <nop,nop,timestamp 4485069 4485103>


##Обычный повтор

Выполним дамп для получения обычного повтора, использую изменение значения drop пакета, чтобы получить пакет в конце взаимодействия между машинами.

    03:25:31.042556 IP 10.10.0.2.44328 > 10.30.0.2.9: P 25301:25401(100) ack 1 win 2920 <nop,nop,timestamp 4667878 4667842>
    03:25:31.052547 IP 10.10.0.2.44328 > 10.30.0.2.9: P 25401:25501(100) ack 1 win 2920 <nop,nop,timestamp 4667878 4667842>
    03:25:31.063131 IP 10.10.0.2.44328 > 10.30.0.2.9: P 25501:25601(100) ack 1 win 2920 <nop,nop,timestamp 4667880 4667842>
    03:25:31.063539 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 25601 win 1048 <nop,nop,timestamp 4667845 4667880>
    03:25:31.072654 IP 10.10.0.2.44328 > 10.30.0.2.9: P 25601:25701(100) ack 1 win 2920 <nop,nop,timestamp 4667881 4667845>
    03:25:31.072884 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 25701 win 1048 <nop,nop,timestamp 4667845 4667881>
    03:25:31.082368 IP 10.10.0.2.44328 > 10.30.0.2.9: P 25701:25801(100) ack 1 win 2920 <nop,nop,timestamp 4667881 4667845>
    03:25:31.082610 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 25801 win 1048 <nop,nop,timestamp 4667847 4667881>
    03:25:31.093440 IP 10.10.0.2.44328 > 10.30.0.2.9: P 25801:25901(100) ack 1 win 2920 <nop,nop,timestamp 4667883 4667847>
    03:25:31.103613 IP 10.10.0.2.44328 > 10.30.0.2.9: P 25901:26001(100) ack 1 win 2920 <nop,nop,timestamp 4667884 4667847>
    03:25:31.113423 IP 10.10.0.2.44328 > 10.30.0.2.9: P 26001:26101(100) ack 1 win 2920 <nop,nop,timestamp 4667885 4667847>
    03:25:31.122737 IP 10.10.0.2.44328 > 10.30.0.2.9: P 26101:26201(100) ack 1 win 2920 <nop,nop,timestamp 4667886 4667847>
    03:25:31.132403 IP 10.10.0.2.44328 > 10.30.0.2.9: P 26201:26301(100) ack 1 win 2920 <nop,nop,timestamp 4667886 4667847>
    03:25:31.142914 IP 10.10.0.2.44328 > 10.30.0.2.9: P 26301:26401(100) ack 1 win 2920 <nop,nop,timestamp 4667888 4667847>
    03:25:31.342326 IP 10.10.0.2.44328 > 10.30.0.2.9: P 25801:26001(200) ack 1 win 2920 <nop,nop,timestamp 4667907 4667847>
    03:25:31.521442 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 26101 win 1048 <nop,nop,timestamp 4667850 4667885>
    03:25:31.521457 IP 10.10.0.2.44328 > 10.30.0.2.9: . 26401:26925(524) ack 1 win 2920 <nop,nop,timestamp 4667924 4667850>
    03:25:31.521474 IP 10.10.0.2.44328 > 10.30.0.2.9: . 26925:27449(524) ack 1 win 2920 <nop,nop,timestamp 4667924 4667850>
    03:25:31.531901 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 26201 win 1048 <nop,nop,timestamp 4667850 4667886>
    03:25:31.531920 IP 10.10.0.2.44328 > 10.30.0.2.9: . 27449:27973(524) ack 1 win 2920 <nop,nop,timestamp 4667926 4667850>
    03:25:31.541937 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 26301 win 1048 <nop,nop,timestamp 4667852 4667886>
    03:25:31.551712 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 26401 win 1048 <nop,nop,timestamp 4667853 4667888>
    03:25:31.551740 IP 10.10.0.2.44328 > 10.30.0.2.9: . 27973:28497(524) ack 1 win 2920 <nop,nop,timestamp 4667928 4667853>
    03:25:31.751661 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 26401 win 1048 <nop,nop,timestamp 4667872 4667888,nop,nop,sack 1 {25801:26001}>
    03:25:31.932009 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 26925 win 1572 <nop,nop,timestamp 4667890 4667924>
    03:25:31.932030 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 27449 win 2096 <nop,nop,timestamp 4667890 4667924>
    03:25:31.941507 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 27973 win 2620 <nop,nop,timestamp 4667892 4667926>
    03:25:31.941527 IP 10.10.0.2.44328 > 10.30.0.2.9: . 28497:29021(524) ack 1 win 2920 <nop,nop,timestamp 4667967 4667892>
    03:25:31.961816 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 28497 win 3144 <nop,nop,timestamp 4667893 4667928>
    03:25:31.961842 IP 10.10.0.2.44328 > 10.30.0.2.9: . 29021:29545(524) ack 1 win 2920 <nop,nop,timestamp 4667968 4667893>
    03:25:31.961870 IP 10.10.0.2.44328 > 10.30.0.2.9: FP 29545:30001(456) ack 1 win 2920 <nop,nop,timestamp 4667968 4667893>
    03:25:32.351574 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 29021 win 3668 <nop,nop,timestamp 4667932 4667967>
    03:25:32.371432 IP 10.30.0.2.9 > 10.10.0.2.44328: . ack 29545 win 4192 <nop,nop,timestamp 4667934 4667968>
    03:25:32.371452 IP 10.30.0.2.9 > 10.10.0.2.44328: F 1:1(0) ack 30002 win 4716 <nop,nop,timestamp 4667934 4667968>
    03:25:32.371461 IP 10.10.0.2.44328 > 10.30.0.2.9: . ack 2 win 2920 <nop,nop,timestamp 4668009 4667934>

##Опыт с PMTU

На машинах c3 и c4 необходимо отключить tcpclump командой iptables -F.
Попробуем провести опыт с PMTU:

    c2:~# tcpdump -n -i eth0 tcp
    tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
    listening on eth0, link-type EN10MB (Ethernet), capture size 96 bytes
    03:44:52.111057 IP 10.10.0.2.37063 > 10.50.0.2.9: S 2838793157:2838793157(0) win 5840 <mss 1460,sackOK,timestamp 4294966140 0,nop,wscale 1>
    03:44:52.113930 IP 10.50.0.2.9 > 10.10.0.2.37063: S 2845923488:2845923488(0) ack 2838793158 win 5792 <mss 1460,sackOK,timestamp 4294966141 4294966140,nop,wscale 1>
    03:44:52.115360 IP 10.10.0.2.37063 > 10.50.0.2.9: . ack 1 win 2920 <nop,nop,timestamp 4294966140 4294966141>
    03:44:52.120172 IP 10.10.0.2.37063 > 10.50.0.2.9: P 1:101(100) ack 1 win 2920 <nop,nop,timestamp 4294966140 4294966141>
    03:44:52.120519 IP 10.50.0.2.9 > 10.10.0.2.37063: . ack 101 win 2896 <nop,nop,timestamp 4294966141 4294966140>
    ...
    03:49:12.716573 IP 10.10.0.2.33167 > 10.50.0.2.9: S 2631833600:2631833600(0) win 5840 <mss 1460,sackOK,timestamp 24904 0,nop,wscale 1>
    03:49:12.716942 IP 10.50.0.2.9 > 10.10.0.2.33167: S 2626310940:2626310940(0) ack 2631833601 win 5792 <mss 1460,sackOK,timestamp 24905 24904,nop,wscale 1>
    03:49:12.717015 IP 10.10.0.2.33167 > 10.50.0.2.9: . ack 1 win 2920 <nop,nop,timestamp 24904 24905>
    03:49:12.756030 IP 10.10.0.2.33167 > 10.50.0.2.9: . 1:525(524) ack 1 win 2920 <nop,nop,timestamp 24910 24905>
    03:49:12.756561 IP 10.50.0.2.9 > 10.10.0.2.33167: . ack 525 win 3432 <nop,nop,timestamp 24909 24910>
    03:49:12.806152 IP 10.10.0.2.33167 > 10.50.0.2.9: . 525:1049(524) ack 1 win 2920 <nop,nop,timestamp 24914 24909>
    03:49:12.807085 IP 10.50.0.2.9 > 10.10.0.2.33167: . ack 1049 win 3956 <nop,nop,timestamp 24914 24914>
    03:49:12.856196 IP 10.10.0.2.33167 > 10.50.0.2.9: . 1049:1573(524) ack 1 win 2920 <nop,nop,timestamp 24920 24914>
    03:49:12.856847 IP 10.50.0.2.9 > 10.10.0.2.33167: . ack 1573 win 4480 <nop,nop,timestamp 24919 24920>

Отправим сегменты с полностью заполненным MSS, используя программу nagle и режим TCP_CORK агрессивной буферезации.
Машина-отправитель c1 дважды получает ICMP извещения о невозможности передачи пакета без фрагментации.

    08:29:42.595108 IP 10.10.0.2.47552 > 10.50.0.2.9: S 3869996364:3869996364(0) win 5840 <mss 1460,sackOK,timestamp 1707892 0,nop,wscale 1>
    08:29:42.629940 IP 10.50.0.2.9 > 10.10.0.2.47552: S 3883584240:3883584240(0) ack 3869996365 win 5792 <mss 1460,sackOK,timestamp 1707896 1707892,nop,wscale 1>
    08:29:42.631040 IP 10.10.0.2.47552 > 10.50.0.2.9: . ack 1 win 2920 <nop,nop,timestamp 1707896 1707896>
    08:29:42.766032 IP 10.10.0.2.47552 > 10.50.0.2.9: . 1:1449(1448) ack 1 win 2920 <nop,nop,timestamp 1707910 1707896>
    08:29:42.766082 IP 10.10.0.1 > 10.10.0.2: ICMP 10.50.0.2 unreachable - need to frag (mtu 1492), length 556
    08:29:42.766335 IP 10.10.0.2.47552 > 10.50.0.2.9: . 1:1441(1440) ack 1 win 2920 <nop,nop,timestamp 1707910 1707896>
    08:29:42.766353 IP 10.10.0.2.47552 > 10.50.0.2.9: . 1441:1449(8) ack 1 win 2920 <nop,nop,timestamp 1707910 1707896>
    08:29:42.766497 IP 10.20.0.2 > 10.10.0.2: ICMP 10.50.0.2 unreachable - need to frag (mtu 576), length 556
    08:29:42.766992 IP 10.50.0.2.9 > 10.10.0.2.47552: . ack 1 win 2896 <nop,nop,timestamp 1707910 1707896,nop,nop,sack 1 {1441:1449}>
    08:29:42.767073 IP 10.10.0.2.47552 > 10.50.0.2.9: . 1:525(524) ack 1 win 2920 <nop,nop,timestamp 1707910 1707910>
    08:29:42.767094 IP 10.10.0.2.47552 > 10.50.0.2.9: . 525:1049(524) ack 1 win 2920 <nop,nop,timestamp 1707910 1707910>
    08:29:42.767464 IP 10.50.0.2.9 > 10.10.0.2.47552: . ack 525 win 3432 <nop,nop,timestamp 1707910 1707910,nop,nop,sack 1 {1441:1449}>
    08:29:42.767477 IP 10.50.0.2.9 > 10.10.0.2.47552: . ack 1049 win 3956 <nop,nop,timestamp 1707910 1707910,nop,nop,sack 1 {1441:1449}>
    08:29:42.767541 IP 10.10.0.2.47552 > 10.50.0.2.9: . 1049:1441(392) ack 1 win 2920 <nop,nop,timestamp 1707910 1707910>
    08:29:42.767865 IP 10.50.0.2.9 > 10.10.0.2.47552: . ack 1449 win 4480 <nop,nop,timestamp 1707910 1707910>
    08:29:42.816210 IP 10.10.0.2.47552 > 10.50.0.2.9: . 1449:1973(524) ack 1 win 2920 <nop,nop,timestamp 1707916 1707910>
    08:29:42.816893 IP 10.50.0.2.9 > 10.10.0.2.47552: . ack 1973 win 5004 <nop,nop,timestamp 1707915 1707916>

С помощью протокола TCP сразу была выполнена повторная отправка сообщения, разбитого на фрагменты в соответствии с полученным значением MTU.
Если просмотреть кэш таблицы маршрутизации на машине c1, можно увидеть новое значение MTU для адреса машины c2:

    c1:~# ip r show cache
    local 10.10.0.2 from 10.50.0.2 dev lo  src 10.10.0.2 
        cache <local>  iif eth0
    local 10.10.0.2 from 10.20.0.2 dev lo  src 10.10.0.2 
        cache <local>  iif eth0
    10.50.0.2 via 10.10.0.1 dev eth0  src 10.10.0.2 
        cache  expires 589sec mtu 576 advmss 1460 hoplimit 64
    local 10.10.0.2 from 10.10.0.1 dev lo  src 10.10.0.2 
        cache <local,src-direct>  iif eth0
    10.50.0.2 from 10.10.0.2 via 10.10.0.1 dev eth0 
        cache  expires 589sec mtu 576 rtt 26ms rttvar 25ms cwnd 6 advmss 1460 hoplimit 64

##Соединение с неверным портом

Выполним попытку соединиться с портом, который не слушает сервер:

    c1:~# ./nagle nodelay 10.30.0.2 9000 1 300
    connect: Connection refused

Выполним tcpdump на машине c3:

    c3:~# tcpdump -n -i eth0 tcp
    tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
    listening on eth0, link-type EN10MB (Ethernet), capture size 96 bytes
    03:29:27.919836 IP 10.10.0.2.49554 > 10.30.0.2.9000: S 2603178729:2603178729(0) win 5840 <mss 1460,sackOK,timestamp 4691552 0,nop,wscale 1>
    03:29:28.321349 IP 10.30.0.2.9000 > 10.10.0.2.49554: R 0:0(0) ack 2603178730 win 0

Клиент получает сообщение Connection refused и в tcpdump мы видим пакет с флагом Reset, соединение не было установлено. 
